steps:
  - name: 'bash'
    script: |
      #!/usr/bin/env bash
      rm -R  .pip-cache-build || true
      mkdir .pip-cache-build
      cp .gcloud/pip-cache.Dockerfile .pip-cache-build/Dockerfile
      cp requirements*txt .pip-cache-build/

  - name: gcr.io/cloud-builders/docker
    args:
      - buildx
      - build
      - '-t'
      - '$_GCR_HOSTNAME/$PROJECT_ID/pip-cache:$COMMIT_SHA'
      - '-t'
      - '$_GCR_HOSTNAME/$PROJECT_ID/pip-cache:latest'
      - '-f'
      - pip-cache.Dockerfile
      - .
      - '-o'
      - type=image
    dir: .pip-cache-build
    id: Build-Pip-Cache

  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - '$_GCR_HOSTNAME/$PROJECT_ID/pip-cache:$COMMIT_SHA'
    id: Push-Pip-Cache
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - '$_GCR_HOSTNAME/$PROJECT_ID/datareporter:latest'
    id: Push-Data-Reporter-Latest
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - '$_GCR_HOSTNAME/$PROJECT_ID/plywood:latest'
    id: Push-Plywood-Latest
  - name: gcr.io/cloud-builders/gcloud
    args:
      - '-c'
      - >-
        gcloud builds triggers  run datareporter-deploy-pinadventures
        --sha=$COMMIT_SHA --substitutions=_IMAGE_TAG="$COMMIT_SHA"
    id: Deploy-Pinadventures
    entrypoint: bash
images:
  - '$_GCR_HOSTNAME/$PROJECT_ID/datareporter:$COMMIT_SHA'
  - '$_GCR_HOSTNAME/$PROJECT_ID/plywood:$COMMIT_SHA'
options:
  substitutionOption: ALLOW_LOOSE
substitutions:
  _GCR_HOSTNAME: eu.gcr.io
